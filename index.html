<html>
	<head>
	
			<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		  crossorigin=""/>
	  
		 <!-- Make sure you put this AFTER Leaflet's CSS -->
		 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		   crossorigin=""></script>

        <!-- Load Esri Leaflet from CDN -->
		  <script src="https://unpkg.com/esri-leaflet@3.0.1/dist/esri-leaflet.js"
          integrity="sha512-JmpptMCcCg+Rd6x0Dbg6w+mmyzs1M7chHCd9W8HPovnImG2nLAQWn3yltwxXRM7WjKKFFHOAKjjF2SC4CgiFBg=="
          crossorigin=""></script>
          
        <!-- Load Leaflet MarkerCluster and Esri Leaflet Cluster from CDN -->
        <link rel="stylesheet" type="text/css"
          href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
          integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ=="
          crossorigin="">
        <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
          integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ=="
          crossorigin="">
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
          integrity="sha512-MQlyPV+ol2lp4KodaU/Xmrn+txc1TP15pOBF/2Sfre7MRsA/pB4Vy58bEqe9u7a7DczMLtU5wT8n7OblJepKbg=="
          crossorigin=""></script>
        <script src="https://unpkg.com/esri-leaflet-cluster@2.1.0/dist/esri-leaflet-cluster.js"
          integrity="sha512-fEdNFHisleVtEYdLhW4Z2RsR7TN6hLutE/+O4D+skfTNY2rlHm8HOZARPWkdrFFy/+i2KjFxcZAKTUWaVfbV0g=="
          crossorigin=""></script>

          <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		
	<!-- Load Esri Leaflet Geocoder from CDN -->
		
  		<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.css"
    		integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
   	 	crossorigin="">
  		<script src="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.js"
    		integrity="sha512-vZbMwAf1/rpBExyV27ey3zAEwxelsO4Nf+mfT7s6VTJPUbYmD2KSuTRXTxOFhIYqhajaBU+X5PuFK1QJ1U9Myg=="
    		crossorigin=""></script>

		 <style>  
			 #mapid { 
				height: 60%;
                                width: 100%;
			 }
			/* #mapid { height: 480px; } */
		 </style> 
	</head>
	<body>
	
		<div id="mapid"></div>
            <div>
                <p id="temp"></p>
            </div>
		<script>
        // Creating the map variable and setting zoom and coordinates to Ontario, Canada     
		var map = L.map('mapid').setView([51.2538, -85.3232], 5);
		
		L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWp1dHppIiwiYSI6ImNrbGQ3d2E4MTE3cHAydXFlanJ1aG9maG4ifQ.6MOuQtvruOzh95-1C3i0jg', {
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
			maxZoom: 19,
			id: 'mapbox/streets-v11',
			tileSize: 512,
			zoomOffset: -1,
			accessToken: 'pk.eyJ1IjoiYWp1dHppIiwiYSI6ImNrbGQ3d2E4MTE3cHAydXFlanJ1aG9maG4ifQ.6MOuQtvruOzh95-1C3i0jg'
		}).addTo(map);
		
        // Creating variables for weather tile layers
        // OpenWeatherMap API tile reference: https://openweathermap.org/api/weathermaps
        // Leaflet tile reference: https://leafletjs.com/reference-1.7.1.html#tilelayer
        // Javascript 'new' operator reference: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/new
		var precip = (new L.TileLayer("http://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			weather = (new L.TileLayer("http://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			wind = (new L.TileLayer("http://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			clouds = (new L.TileLayer("http://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38")),
			pressure = (new L.TileLayer("http://tile.openweathermap.org/map/pressure_new/{z}/{x}/{y}.png?appid=35b79f04000d801c24276115e7093f38"));
		
		    
        // Key-value pairs used for the control panel 
        // Keys are the text values seen in the control panel, and the values are the corresponding tile layer variables
        // Layer groups and layers control tutorial: https://leafletjs.com/examples/layers-control/
		var overlayMaps = {
		"Precipitation" : precip,
		"Weather" : weather,
		"Wind" : wind,
		"Clouds" : clouds,
		"Pressure" : pressure
		};
		
        // Control panel in top left corner
        // Gives user the ability to toggle between different weather layers
		L.control.layers(overlayMaps).addTo(map);

        var trailheads = L.esri.Cluster.featureLayer({
			url: 'https://ws.lioservices.lrc.gov.on.ca/arcgis1071a/rest/services/LIO_OPEN_DATA/LIO_Open04/MapServer/20'
		}).addTo(map);

		trailheads.bindPopup(function (layer) {
            if (theMarker != undefined) {
					  map.removeLayer(theMarker);
				};
			return L.Util.template('<p>Trail: <strong>{TRAIL_NAME}</strong><br>Association: {TRAIL_ASSOCIATION}<br>Website: {TRAIL_ASSOCIATION_WEBSITE}<br>Activity: {ACTIVITY}<br>Description: <i>{DESCRIPTION}</i><br>Length: {LENGTH_KMS}km<br>Difficulty: {OTC_TRAIL_CHALLENGE}</p>', layer.feature.properties);
		});
		
		var trailPaths = L.esri.featureLayer({
			url: 'https://ws.lioservices.lrc.gov.on.ca/arcgis1071a/rest/services/LIO_OPEN_DATA/LIO_Open04/MapServer/19'
		});
		
		trailPaths.bindPopup(function (layer) {
            if (theMarker != undefined) {
					  map.removeLayer(theMarker);
				};
			return L.Util.template('<p><strong>Path material:{SURFACE_DETAIL}</strong></p>', layer.feature.properties);
		});

        // source: https://github.com/pointhi/leaflet-color-markers
		var greyIcon = new L.Icon({
		  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
		  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
		  iconSize: [18.75, 30.75],
		  iconAnchor: [9, 30.75],
		  popupAnchor: [1, -34],
		  shadowSize: [30.75, 30.75]
		});

		// source: https://gis.stackexchange.com/questions/238414/adding-a-new-and-removing-an-old-marker-every-time-the-user-click-on-the-map
		 var theMarker = {};

		  map.on('click',function(e){
			lat = e.latlng.lat;
			lon = e.latlng.lng;

			console.log("You clicked the map at LAT: "+ lat+" and LONG: "+lon );
				//Clear existing marker, 

				if (theMarker != undefined) {
					  map.removeLayer(theMarker);
				};

			//Add a marker to show where you clicked.
			 theMarker = L.marker([lat,lon], {icon: greyIcon}).addTo(map);  
		});

        // user gets weather data by clicking a location on the tile map
        map.on('click', function(layer){
		  var latlng = map.mouseEventToLatLng(layer.originalEvent);
		  console.log(latlng.lat + ', ' + latlng.lng);
		  //alert(latlng.lat + ' , ' + latlng.lng);
		  $.get( "https://api.openweathermap.org/data/2.5/weather?units=metric&lat="+latlng.lat+"&lon="+latlng.lng+"&appid=35b79f04000d801c24276115e7093f38", function( data ) {
			  console.log(data);
			  var weatherdata = JSON.stringify(data);
			  //alert( "Data Loaded: " + weatherdata );
              var obj = JSON.parse(weatherdata);
			  
			  // returning json values help: https://idratherbewriting.com/learnapidoc/docapis_access_json_values.html
			  document.getElementById("temp").innerHTML = "Marker coordinates: " + latlng.lat.toFixed(5) + ', ' + latlng.lng.toFixed(5) + "<br />" +
			  "Current weather: " + obj.main.temp + " °C" +  "<br />" + "Feels like: " + obj.main.feels_like + " °C"
			  + "<br />" + obj.weather[0].main
			  + "<br />" + obj.weather[0].description
			  + "<br />" + "Visibility: " + obj.visibility + " m"
			  + "<br />" + "Wind gust: " + obj.wind.gust + " km/h";
            
            });
		});

        trailheads.on('click', function(layer){
		  var latlng = map.mouseEventToLatLng(layer.originalEvent);
		  console.log(latlng.lat + ', ' + latlng.lng);
		  $.get( "https://api.openweathermap.org/data/2.5/weather?units=metric&lat="+latlng.lat+"&lon="+latlng.lng+"&appid=35b79f04000d801c24276115e7093f38", function( data ) {
			  console.log(data);
			  var weatherdata = JSON.stringify(data);
			  //alert( "Data Loaded: " + weatherdata );
			  var obj = JSON.parse(weatherdata);
			  
			  // returning json values help: https://idratherbewriting.com/learnapidoc/docapis_access_json_values.html
			  document.getElementById("temp").innerHTML = "Marker coordinates: " + latlng.lat.toFixed(5) + ', ' + latlng.lng.toFixed(5) + "<br />" +
			  "Current weather: " + obj.main.temp + " °C" +  "<br />" + "Feels like: " + obj.main.feels_like + " °C"
			  + "<br />" + obj.weather[0].main
			  + "<br />" + obj.weather[0].description
			  + "<br />" + "Visibility: " + obj.visibility + " m"
			  + "<br />" + "Wind gust: " + obj.wind.gust + " km/h";
            });
		});
			
	    //Search feature layer Trail names plus geocoding//
    
        var arcgisOnlineProvider = L.esri.Geocoding.arcgisOnlineProvider({
            apikey: "AAPKb0ca0bbad2b54f9e95e3a84f0c93fa55Bthlfs8V3jANIB6Sxe9b2f1aoBAHWR9j07K021pFKJ60hj3eSSHb9pvAqsxDRuGt"
        }); 

        var trailsProvider = L.esri.Geocoding.featureLayerProvider({
            url: 'https://ws.lioservices.lrc.gov.on.ca/arcgis1071a/rest/services/LIO_OPEN_DATA/LIO_Open04/MapServer/20',
            searchFields: ['TRAIL_NAME'],
            label: 'Ontario Trails',
            bufferRadius: 5000,
            formatSuggestion: function (feature) {
            return feature.properties.TRAIL_NAME;
            }
        });
  
        L.esri.Geocoding.geosearch({
            providers: [arcgisOnlineProvider, trailsProvider]
        }).addTo(map);

    
        // minimum zoom level for the trailPaths layer
        // source: https://gis.stackexchange.com/questions/182628/leaflet-layers-on-different-zoom-levels-how
        map.on('zoomend', function() {
            var zoomlevel = map.getZoom();
                if (zoomlevel  <10){
                    if (map.hasLayer(trailPaths)) {
                        map.removeLayer(trailPaths);
                    } else {
                        console.log("no point layer active");
                    }
                }
                if (zoomlevel >= 10){
                    if (map.hasLayer(trailPaths)){
                        console.log("layer already added");
                    } else {
                        map.addLayer(trailPaths);
                    }
                }
            console.log("Current Zoom Level =" + zoomlevel)
            });
                    

		
		</script>

	</body>
</html>
